<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>JPrasojo's blog</title>
	<meta name="description" content="">
	<meta name="author" content="Lintang JP">

	<!-- HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="/theme/html5.js"></script>
	<![endif]-->

	<!-- Styles -->
	<link href="/theme/bootstrap.min.css" rel="stylesheet">
	<link href="/theme/local.css" rel="stylesheet">
	<link href="/theme/pygments.css" rel="stylesheet">

	<!-- Feeds -->




</head>
<body>
	<div class="topbar">
	  <div class="topbar-inner">
		<div class="container-fluid">
		  <a class="brand" href="/">JPrasojo's blog</a>
			<ul class="nav">
						<li><a href="/pages/hello-world.html">About</a></li>
					<li ><a href="/category/family.html">Family</a></li>
					<li ><a href="/category/java.html">Java</a></li>
					<li ><a href="/category/renungan.html">Renungan</a></li>
					<li ><a href="/category/telco.html">Telco</a></li>
					<li ><a href="/category/travelling.html">Travelling</a></li>
					<li class="active"><a href="/category/unixlinux.html">Unix/Linux</a></li>
			</ul>
			<p class="pull-right"><a href="/archives.html">[archives]</a> <a href="/tags.html">[tags]</a></p>
		</div>
	  </div>
	</div>

	<div class="container-fluid">
	  <div class="sidebar">
		<div class="well">
			<h3>Blogroll</h3>
			<ul>
				<li><a href="http://getpelican.com/">Pelican</a></li>
				<li><a href="http://python.org/">Python.org</a></li>
				<li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
				<li><a href="http://theprasojos.wordpress.com">Theprasojos Family</a></li>
			</ul>
			<div class="social">
			<h3>Social</h3>
			<ul>
				<li><a href="https://twitter.com/jprasojo">Twitter</a></li>
				<li><a href="https://www.linkedin.com/in/lintangprasojo">Linkedin</a></li>
			</ul>
			</div>
		</div>
	  </div>
	  <div class="content">
	<div class='article'>
		<div class="page-header"><h1>Bye bye apache, welcome Nginx</h1></div>
		<div class="well small">Permalink: <a class="more" href="/bye-bye-apache-welcome-nginx.html">2008-12-22 00:00:00+00:00</a>
by <a class="url fn" href="/author/lintang-jp.html">Lintang JP </a>
 in <a href="/category/unixlinux.html">Unix/Linux</a>
tags: <a href="/tag/atutor-unix-linux-stuff-web-server-internet-nginx.html">aTutor Unix Linux stuff Web Server Internet Nginx</a> </div>
		<div><p>Bagi saya, php tetap memiliki kenangan yang indah dalam mengisi hari-hari pemrograman saya terdahulu. Programming language yang fleksibel, dan nggak pake ribet. Justru kesulitan ditemui ketika deploy di server. Kebanyakan server yang tersedia sudah diinstall default dengan bundle apache, beserta modul-modul yang sudah di tentukan sebelumnya. Kalau pake keluarga Redhat, iya kalau kebetulan dapet rpm yang pas versinya, kalo nggak ? Cara paling enak memang tetap dengan compile dari source, karena kita bisa bongkar pasang modul yang kita inginkan, tambahkan semaunya, kurangi sesukanya. Jaman dulu(nggak dulu banget sih, 2004), saya hanya kenal Apache dan IIS buat jadi webserver untuk skrip php saya. Belakangan ini, muncul sebuah webserver yang tidak terlalu terkenal, tapi sepertinya ampuh. Kenapa ampuh ? Coba anda pergi ke netcraft.com, dan coba anda scan situs wordpress.com dan detik.com, apa webserver mereka ? Mereka pakai Nginx (baca:engine X). Ini dua situs besar loh, dan saya sangat yakin, tiap hari banyak diantara kita yang berinteraksi dengan kedua situs ini, ya tho ? Nggak mungkin dong mereka pake webserver yang kurang 'terkenal' kalo nggak karena mereka merasakan keampuhan dibaliknya, tul ndak ? Coba buka aja deh langsung di <a href="http://nginx.net/">situsnya</a>.</p>
<p>Ok, karena saya bukan pembuat Nginx, sejarahnya tidak akan saya beberkan disini. Berikut sebagai pengingat saja buat saya (syukur kalau berguna buat anda juga) untuk ngebangun server PHP siap pakai dengan Nginx dan lighttpd.
Berikut Linux saya, ubuntu 7.10 :
lintang@cygnus:~$ uname -a
Linux cygnus 2.6.22-14-generic #1 SMP Sun Oct 14 23:05:12 GMT 2007 i686 GNU/Linux
Disini kebetulan waktu nginstall, saya pake apt-get saja untuk nginx nya, baru php dan lighttpdnya yang compile dari source. Selain nginx, kita juga harus install dependenciesnya, terutama pcre dan zlib, serta openssl kalau anda ingin.
root@cygnus:~# apt-get install libpcre3 libpcre3-dev zlib1g zlib1g-dev nginx
Tunggu sejenak, bikin kopi dulu juga boleh. Atau kalau anda ingin waktu anda efisien, mari kita donlot dulu PHP dan Lighttpd nya :D
Saya ambil PHP versi 5.2.6, dan Lighttpd versi 1.4.19. Dari mana ? please deh, silakan googling, mudah didapat kok kedua-duanya.
Ok, kita mulai dengan PHP dulu, silakan ekstrak, compile, dan install. Berikut opsi yang saya gunakan untuk PHP saya.
lintang@cygnus:~$ ./configure --prefix=/usr/local/php-5.2.6 --with-mysql --enable-fastcgi --with-sockets --with-zlib
Ini berarti, kita akan instal PHP kita nanti di direktori /usr/local/php-5.2.6, mengikut-sertakan library koneksi php untuk mysql, membuat PHP yang berfungsi sebagai interpreter CGI ( nantinya skrip PHP bisa dijalankan dari shell, mirip /bin/bash atau /usr/bin/perl), lalu PHP tersebut dapat memiliki/membuka socket tersendiri (nantinya PHP akan berjalan sebagai process yang terpisah dari webserver, tidak seperti model Apache dimana PHP berjalan sebagai modul di dalamnya), lalu yang terakhir, mengikut sertakan library php untuk support kompresi dengan tipe Gzip.
Tunggu sejenak, setelah sukses, silakan lakukan langkah dibawah seperti biasa :
lintang@cygnus:~$ make
lintang@cygnus:~$ sudo make install
Nah, coba cek di direktori /usr/local/php-5.2.6/bin, seharusnya ada file executable bernama php-cgi. File inilah yang akan berjalan sebagai interpreter PHP anda dari shell.
Menurut beberapa sumber dari internet, sebenarnya php-cgi ini saja cukup untuk dipanggil dari Nginx nantinya untuk menjalankan PHP, namun akan lebih baik apabila kita mengambil spawner dari project Lighttpd. Spawner ini akan mengeksekusi php-cgi kita. Berikut langkah-langkahnya, seperti biasa, silakan ekstrak Lig
lintang@cygnus:~$ ./configure --prefix=/opt/lighttpd-1.4.19 --enable-static --disable-shared
Kira-kira maksudnya, kita akan menconfigure Lighttpd sebagai library static yang dependenciesnya mutlak terhadap file-file .so tertentu. Opsi static ini membuat program yang kita compile akan jauh lebih cepat, karena versi dependencies di dalamnya seperti di hardcode. Berkebalikan dengan ketika kita compile dengan modus dinamis, hasilnya program akan lebih lambat, namun dependencies terhadap versi library tertentu bisa dihindari. Kalau kita ingin membuat server yang cepat, siapa peduli dengan dinamisasi, bukan begitu ? :p
Lalu seperti biasa, kita jalankan make, tapi kali ini tanpa make install.
lintang@cygnus:~$ make
Seharusnya nanti, di direktori src/ akan ada file bernama spawn-fcgi. Kopikan file tersebut ke directory /usr/bin sebagai berikut :
lintang@cygnus:~$ sudo cp spawn-fcgi /usr/bin/
Lalu anda buat skrip .sh sederhana sebagai berikut :</p>
<div class="highlight"><pre><span class="n">lintang</span><span class="err">@</span><span class="n">cygnus</span><span class="o">:/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="mf">5.2.6</span><span class="err">$</span> <span class="n">cat</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">fastcgi</span> <span class="err">#</span><span class="o">!/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span>

<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">spawn</span><span class="o">-</span><span class="n">fcgi</span> <span class="o">-</span><span class="n">a</span> <span class="mf">127.0.0.1</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8999</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="mf">5.2.6</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">cgi</span>
</pre></div>


<p>Ini adalah skrip untuk menjalankan PHP sebagai proses CGI yang terpisah dari webserver anda nantinya. PHP akan membuka socket di port 8999, dan akan binding di interface lo(127.0.0.1) anda, sehingga hanya bisa diakses dari mesin anda sendiri.
Ok, langkah terakhir tinggal setup nginx.conf anda, punya saya ada di sini /etc/nginx/nginx.conf.
Berikut isi file konfigurasi Nginx saya :</p>
<div class="highlight"><pre><span class="n">user</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">;</span>
<span class="n">worker_processes</span> <span class="mi">4</span><span class="p">;</span>

<span class="n">error_log</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">error</span><span class="p">.</span><span class="n">log</span><span class="p">;</span>
<span class="n">pid</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">pid</span><span class="p">;</span>

<span class="n">events</span> <span class="p">{</span>
<span class="n">worker_connections</span> <span class="mi">1024</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">http</span> <span class="p">{</span>
<span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">mime</span><span class="p">.</span><span class="n">types</span><span class="p">;</span>
<span class="n">default_type</span> <span class="n">application</span><span class="o">/</span><span class="n">octet</span><span class="o">-</span><span class="n">stream</span><span class="p">;</span>

<span class="n">access_log</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">access</span><span class="p">.</span><span class="n">log</span><span class="p">;</span>

<span class="n">sendfile</span> <span class="n">on</span><span class="p">;</span>
<span class="cp">#tcp_nopush on;</span>

<span class="cp">#keepalive_timeout 0;</span>
<span class="n">keepalive_timeout</span> <span class="mi">65</span><span class="p">;</span>
<span class="n">tcp_nodelay</span> <span class="n">on</span><span class="p">;</span>
<span class="n">gzip</span> <span class="n">on</span><span class="p">;</span>

<span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">enabled</span><span class="o">/*</span><span class="p">;</span>

<span class="p">}</span>
</pre></div>


<p>Perhatikan baris yang di bold, bahwa Nginx saya berjalan atas nama user www-data, sehingga user ini mutlak harus ada sebelumnya, sepertinya kalau di Ubuntu, user ini dibuatkan otomatis ketika kita install Nginx yah, saya lupa sih :D.
Baris selanjutnya, worker_processes, saya isi 4. User yang mengakses webserver saya disini kurang dari 100 orang, dan selama ini, 4 worker sudah cukup sih.
Lalu selanjutnya, gzip on, ini modul gzip compress yang kita aktifkan setelah sebelumnya kita install zlib. Dan yang terakhir, kita akan meng-include kan semua file konfigurasi di direktori /etc/nginx/sites-enabled. Berikut contoh file konfigurasi saya di direktori tersebut :</p>
<div class="highlight"><pre><span class="n">Filename</span> <span class="o">:</span> <span class="n">atutor</span><span class="o">.</span><span class="na">conf</span>
<span class="n">server</span> <span class="o">{</span>
<span class="n">listen</span> <span class="mi">80</span><span class="o">;</span>
<span class="n">server_name</span> <span class="n">atutor</span><span class="o">;</span>

<span class="n">access_log</span> <span class="sr">/var/log/nginx/</span><span class="n">atutor</span><span class="o">.</span><span class="na">access</span><span class="o">.</span><span class="na">log</span><span class="o">;</span>

<span class="n">location</span> <span class="o">/</span> <span class="o">{</span>
<span class="n">root</span> <span class="sr">/var/www/</span><span class="n">nginx</span><span class="o">-</span><span class="k">default</span><span class="o">;</span>
<span class="n">index</span> <span class="n">index</span><span class="o">.</span><span class="na">html</span> <span class="n">index</span><span class="o">.</span><span class="na">htm</span> <span class="n">index</span><span class="o">.</span><span class="na">php</span><span class="o">;</span>
<span class="o">}</span>

<span class="err">#</span><span class="n">error_page</span> <span class="mi">404</span> <span class="o">/</span><span class="mi">404</span><span class="o">.</span><span class="na">html</span><span class="o">;</span>

<span class="err">#</span> <span class="n">redirect</span> <span class="n">server</span> <span class="n">error</span> <span class="n">pages</span> <span class="n">to</span> <span class="n">the</span> <span class="kd">static</span> <span class="n">page</span> <span class="o">/</span><span class="mi">50</span><span class="n">x</span><span class="o">.</span><span class="na">html</span>
<span class="err">#</span>
<span class="n">error_page</span> <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span> <span class="o">/</span><span class="mi">50</span><span class="n">x</span><span class="o">.</span><span class="na">html</span><span class="o">;</span>
<span class="n">location</span> <span class="o">=</span> <span class="o">/</span><span class="mi">50</span><span class="n">x</span><span class="o">.</span><span class="na">html</span> <span class="o">{</span>
<span class="n">root</span> <span class="sr">/var/www/nginx-default/</span><span class="n">ATutor</span><span class="o">;</span>
<span class="o">}</span>

<span class="err">#</span> <span class="n">proxy</span> <span class="n">the</span> <span class="n">PHP</span> <span class="n">scripts</span> <span class="n">to</span> <span class="n">Apache</span> <span class="n">listening</span> <span class="n">on</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">80</span>
<span class="err">#</span>
<span class="err">#</span><span class="n">location</span> <span class="o">~</span> <span class="o">.</span><span class="na">php</span><span class="n">$</span> <span class="o">{</span>
<span class="err">#</span><span class="n">proxy_pass</span> <span class="n">http</span><span class="o">://</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">;</span>
<span class="err">#</span><span class="o">}</span>

<span class="err">#</span> <span class="n">pass</span> <span class="n">the</span> <span class="n">PHP</span> <span class="n">scripts</span> <span class="n">to</span> <span class="n">FastCGI</span> <span class="n">server</span> <span class="n">listening</span> <span class="n">on</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">9000</span>
<span class="err">#</span>
<span class="n">location</span> <span class="o">~</span> <span class="o">.</span><span class="na">php</span><span class="n">$</span> <span class="o">{</span>
<span class="n">fastcgi_pass</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">8999</span><span class="o">;</span>
<span class="n">fastcgi_index</span> <span class="n">index</span><span class="o">.</span><span class="na">php</span><span class="o">;</span>
<span class="n">fastcgi_param</span> <span class="n">SCRIPT_FILENAME</span> <span class="sr">/var/www/</span><span class="n">nginx</span><span class="o">-</span><span class="k">default</span><span class="n">$fastcgi_script_name</span><span class="o">;</span>
<span class="k">include</span> <span class="sr">/etc/nginx/</span><span class="n">fastcgi_params</span><span class="o">;</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Konfigurasi ini mengatakan bahwa, saya memiliki sebuah aplikasi (kebetulan aTutor), yang saya letakkan di /var/www/nginx-default, dan untuk semua URL yang berakhiran .php, maka saya akan lemparkan requestnya ke CGI interpreter PHP yang berjalan di port 8999 seperti konfigurasi PHP diatas.</p>
<p>And that's it, kita bisa mengetes konfigurasi nginx kita dengan perintah :
lintang@cygnus:~$ sudo nginx -t
Lalu untuk menjalankan nginx bisa dengan perintah sbb :
lintang@cygnus:~$ sudo nginx
Kalau kita ada perubahan konfigurasi nginx, setelah selesai mengedit file konfigurasi, untuk merestart nginx bisa dengan perintah sbb :
lintang@cygnus:~$ sudo killall -HUP nginx</p>
<p>Udah deh, silakan arahkan browser anda di port 80, aplikasi anda siap melayani user :)</p></div>
	</div>
		<footer>
		  <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme based on <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a>.</p>
		  <p>&copy; Lintang JP</p>
		</footer>
	  </div>

	</div>
</body>
</html>